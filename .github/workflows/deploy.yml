name: Build and Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: new

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        env:
          VITE_ENABLE_CHAT: 'true'

      - name: Build frontend
        run: npm run build
        env:
          VITE_ENABLE_CHAT: 'true'

      - name: Prepare server files
        run: |
          mkdir -p deploy-package
          cp -r dist deploy-package/
          cp server.js deploy-package/
          cp package.json deploy-package/
          cp package-lock.json deploy-package/
          cp ecosystem.config.cjs deploy-package/
          cp -r apache deploy-package/

      - name: Create target dir and deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            mkdir -p /ssd/www/youpublanding/logs

      - name: Deploy files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          source: "deploy-package/*"
          target: "/ssd/www/youpublanding/"
          strip_components: 1
          rm: false

      - name: Install deps and restart server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            cd /ssd/www/youpublanding

            # Установка зависимостей (только production)
            npm ci --omit=dev

            # Создание .env если не существует
            if [ ! -f .env ]; then
              echo "⚠️  .env не найден — создайте вручную: nano /ssd/www/youpublanding/.env"
              echo "VITE_ENABLE_CHAT=true" > .env
              echo "GIGACHAT_API_KEY=" >> .env
              echo "GIGACHAT_SCOPE=GIGACHAT_API_PERS" >> .env
              echo "PORT=3001" >> .env
            fi

            # Перезапуск PM2
            if command -v pm2 &> /dev/null; then
              if pm2 describe youpub-api > /dev/null 2>&1; then
                pm2 restart youpub-api
              else
                pm2 start ecosystem.config.cjs
                pm2 save
              fi
              pm2 status youpub-api
            else
              echo "⚠️  PM2 не установлен. Выполните: npm install -g pm2"
              echo "     Затем: cd /ssd/www/youpublanding && pm2 start ecosystem.config.cjs && pm2 save && pm2 startup"
            fi
