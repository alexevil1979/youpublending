# =============================================================
# Apache VirtualHost для youpub.site
# Объединяет: лендинг + CRM + Chat API на одном домене
# SSL: Let's Encrypt (certbot)
#
# Сертификаты:
#   /etc/letsencrypt/live/youpub.site/fullchain.pem
#   /etc/letsencrypt/live/youpub.site/privkey.pem
#   Обновление: certbot renew (автоматически через cron)
# =============================================================

# --- HTTP → HTTPS редирект (certbot managed) ---
<VirtualHost *:80>
    ServerName youpub.site
    ServerAlias www.youpub.site

    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

# --- Основной HTTPS VirtualHost ---
<VirtualHost *:443>
    ServerName youpub.site
    ServerAlias www.youpub.site
    ServerAdmin admin@youpub.site

    # ===========================================================
    # SSL — Let's Encrypt (certbot)
    # ===========================================================
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/youpub.site/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/youpub.site/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # ===========================================================
    # 1. API (Express/PM2 на порту 3001) — ПРИОРИТЕТ
    # ===========================================================
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3001/api
    ProxyPassReverse /api http://localhost:3001/api

    # ===========================================================
    # 2. CRM приложение — /ssd/www/youpub
    #    Маршруты: /login, /dashboard, /register, /settings и др.
    # ===========================================================
    Alias /login /ssd/www/youpub/login
    Alias /register /ssd/www/youpub/register
    Alias /dashboard /ssd/www/youpub/dashboard
    Alias /settings /ssd/www/youpub/settings
    Alias /profile /ssd/www/youpub/profile
    Alias /billing /ssd/www/youpub/billing

    # CRM — статика (JS/CSS/images)
    Alias /crm-assets /ssd/www/youpub/assets

    <Directory /ssd/www/youpub>
        AllowOverride All
        Require all granted

        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /ssd/www/youpub/index.html [L]
        </IfModule>
    </Directory>

    # ===========================================================
    # 3. Лендинг (Vite build) — всё остальное
    # ===========================================================
    DocumentRoot /ssd/www/youpublanding/dist

    <Directory /ssd/www/youpublanding/dist>
        AllowOverride All
        Require all granted
    </Directory>

    # ===========================================================
    # Логи
    # ===========================================================
    ErrorLog ${APACHE_LOG_DIR}/youpub.site-error.log
    CustomLog ${APACHE_LOG_DIR}/youpub.site-access.log combined
</VirtualHost>
